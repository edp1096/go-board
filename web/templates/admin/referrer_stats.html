<!-- web/templates/admin/referrer_stats.html -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<input type="hidden" id="time-stats-data" value="{{json .timeStats}}">
<input type="hidden" id="type-stats-data" value="{{json .typeStats}}">

<div class="max-w-7xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">레퍼러 통계</h1>

    <div class="mb-6 bg-white shadow rounded-lg p-4">
        <form id="filter-form" class="flex flex-wrap gap-4 items-end">
            <div>
                <label for="days" class="block text-sm font-medium text-gray-700">기간 (일)</label>
                <select id="days" name="days" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    <option value="7" {{if eq .days 7}}selected{{end}}>7일</option>
                    <option value="30" {{if eq .days 30}}selected{{end}}>30일</option>
                    <option value="90" {{if eq .days 90}}selected{{end}}>90일</option>
                    <option value="365" {{if eq .days 365}}selected{{end}}>1년</option>
                </select>
            </div>
            <div>
                <label for="limit" class="block text-sm font-medium text-gray-700">표시 개수</label>
                <select id="limit" name="limit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    <option value="5" {{if eq .limit 5}}selected{{end}}>5개</option>
                    <option value="10" {{if eq .limit 10}}selected{{end}}>10개</option>
                    <option value="20" {{if eq .limit 20}}selected{{end}}>20개</option>
                    <option value="50" {{if eq .limit 50}}selected{{end}}>50개</option>
                </select>
            </div>
            <div>
                <label for="view" class="block text-sm font-medium text-gray-700">보기 모드</label>
                <select id="view" name="view" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    <option value="url" {{if eq .viewMode "url" }}selected{{end}}>URL 별</option>
                    <option value="domain" {{if eq .viewMode "domain" }}selected{{end}}>도메인 별</option>
                </select>
            </div>
            <div>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    적용
                </button>
            </div>
        </form>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- 총 방문 수 -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">요약</h2>
            <div class="text-4xl font-bold text-blue-600">{{.total}}</div>
            <p class="text-gray-500 mt-1">지난 {{.days}}일 동안의 총 방문 수</p>
        </div>

        <!-- 레퍼러 타입 차트 -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">레퍼러 타입 분포</h2>
            <div class="h-64 relative">
                <canvas id="type-chart"></canvas>
            </div>
        </div>

        <!-- 일별 그래프 -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">일별 방문 추이</h2>
            <div class="h-64 relative">
                <canvas id="daily-chart"></canvas>
            </div>
        </div>

        <!-- 상위 레퍼러 -->
        <div class="bg-white shadow rounded-lg p-6 lg:col-span-2">
            <h2 class="text-xl font-semibold mb-4">상위 레퍼러</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                레퍼러
                            </th>
                            {{if eq .viewMode "url"}}
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                도메인
                            </th>
                            {{end}}
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                타입
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                방문 수
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                고유 방문자
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                비율
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {{range .topReferrers}}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{if or (eq .ReferrerURL "direct") (eq .ReferrerDomain "direct")}}
                                직접 방문
                                {{else if eq $.viewMode "domain"}}
                                {{.ReferrerDomain}}
                                {{else}}
                                <a href="{{.ReferrerURL}}" target="_blank" class="text-blue-600 hover:text-blue-900">
                                    {{.ReferrerURL}}
                                </a>
                                {{end}}
                            </td>
                            {{if eq $.viewMode "url"}}
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{.ReferrerDomain}}
                            </td>
                            {{end}}
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <span class='px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {{if eq .ReferrerType "direct"}}bg-gray-100 text-gray-800{{end}}
                                    {{if eq .ReferrerType "search" }}bg-green-100 text-green-800{{end}}
                                    {{if eq .ReferrerType "social" }}bg-blue-100 text-blue-800{{end}}
                                    {{if eq .ReferrerType "other" }}bg-yellow-100 text-yellow-800{{end}}'>
                                    {{if eq .ReferrerType "direct"}}직접 방문{{end}}
                                    {{if eq .ReferrerType "search"}}검색엔진{{end}}
                                    {{if eq .ReferrerType "social"}}소셜미디어{{end}}
                                    {{if eq .ReferrerType "other"}}기타{{end}}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{.Count}}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{.UniqueCount}}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{printf "%.1f" .PercentTotal}}%
                            </td>
                        </tr>
                        {{else}}
                        <tr>
                            <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                데이터가 없습니다
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 레퍼러 타입 통계 테이블 -->
        <div class="bg-white shadow rounded-lg p-6 lg:col-span-2">
            <h2 class="text-xl font-semibold mb-4">레퍼러 타입 통계</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                레퍼러 타입
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                방문 수
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                비율
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {{range .typeStats}}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                <span class='px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {{if eq .Type "direct"}}bg-gray-100 text-gray-800{{end}}
                                    {{if eq .Type "search" }}bg-green-100 text-green-800{{end}}
                                    {{if eq .Type "social" }}bg-blue-100 text-blue-800{{end}}
                                    {{if eq .Type "other" }}bg-yellow-100 text-yellow-800{{end}}'>
                                    {{if eq .Type "direct"}}직접 방문{{end}}
                                    {{if eq .Type "search"}}검색엔진{{end}}
                                    {{if eq .Type "social"}}소셜미디어{{end}}
                                    {{if eq .Type "other"}}기타{{end}}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{.Count}}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{printf "%.1f" .PercentTotal}}%
                            </td>
                        </tr>
                        {{else}}
                        <tr>
                            <td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                데이터가 없습니다
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>